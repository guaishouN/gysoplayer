#### Nginx RTMP服务器配置与搭建

简书：https://www.jianshu.com/p/cf7f0552ffe9

```shell
######配置推流服务器
#1 下载nginx 并解压
wget http://nginx.org/download/nginx-1.15.3.tar.gz
tar xvf nginx-1.15.3.tar.gz
#2 下载nginx rtmp模块 并解压
wget https://codeload.github.com/arut/nginx-rtmp-module/tar.gz/v1.2.1
tar xvf v1.2.1  
#3 检查依赖包是否已经安装
dpkg -l | grep zlib
sudo apt-get install openssl libssl-dev
sudo apt-get install libpcre3 libpcre3-dev
sudo apt-get install zlib1g-dev
#4 配置nginx  --add-module 指向rtmp模块目录
cd nginx-1.15.3
./configure --prefix=./bin --add-module=../nginx-rtmp-module-1.2.1
 make && make install
#5 编译完成后，安装在当前目录的bin目录下，其实就是从 ` nginx-rtmp-module-1.2.1/test/nginx.conf `中拷贝。
cd bin/conf #注意是bin/conf文件夹下的
gin ## 如附件
sudo ./bin/sbin/nginx -t
#6 查看端口占用 如果回车后没有输出错误内容，表示没有被占用。
 lsof -i:8080
#7 配置防火墙
 阿里云控制台->配置规则->安全组规则,开放8080端口
 sudo ufw status命令查看当前防火墙状态;inactive是关闭 active是开启
 sudo ufw enable|disable
#8 启动 或 停止。一定要在当前目录启动，因为上面的配置error_log logs/error.log debug;  会去执行命令的目录下查找 logs，如果error_log  改成一个绝对路径 那就没关系了
./bin/sbin/nginx -t #测试
./bin/sbin/nginx #开启
./bin/sbin/nginx -s  stop 
./bin/sbin/nginx -s reload
#9 检测
在浏览器中输入http://192.168.187.128:8080/stat查看推流状态
在浏览器中输入http://192.168.187.128:8080
#10 录制
EV录屏或者obs-studio播放
#11 播放
ffplay -i rtmp://192.168.187.128/myapp/
或者使用EV播放rtmp://192.168.187.128/myapp/
```

### 实践过程中发现问题

```
linux上使用root用户
配置中使用
user root
虚拟机中连接超时时间 drop_idle_publisher 30s;
其实这个时间不能设置太短，太短网络较差时会推流失败
路径root /home/guaishou/Documents/nginx-rtmp/nginx-rtmp-module-1.2.1/

项目中如果ffmpeg播放网络串流要等很久才能prepare完毕，如果没有prepare完毕，直接播放则会闪退。

```



#### 附件

```nginx
user root;
worker_processes  1;

error_log  logs/error.log debug;

events {
    worker_connections  1024;
}

rtmp {
    server {
        listen 1935;
        application myapp {
            live on;
            #如果是虚拟机或者网络不好，这个时间超时要设置大点
            drop_idle_publisher 15s;
        }
    }
}
http {
    server {
        listen      8080;
        location /stat {
            rtmp_stat all;
            rtmp_stat_stylesheet stat.xsl;
        }
        location /stat.xsl {
            root /root/nginx-rtmp-module-1.2.1/;
        }
        location /control {
            rtmp_control all;
        }
        location /rtmp-publisher {
            root /root/nginx-rtmp-module-1.2.1/test;
        }

        location / {
            root /root/nginx-rtmp-modu
                le-1.2.1/test/www;
        }
    }
}

```

重定向

```
        location / {
            root   html;
            index  index.html index.htm;
        }

        location /chat {
            return http://www.szdsv.tech;
        }
```

```
worker_processes  1;
 
events {
    worker_connections  1024;
}
 
 
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    server {
        listen       80;
        server_name  localhost;
        location / {
            root   html;
            index  index.html index.htm;
        }
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
 
    }
 
}
```



### Android客户端开发环境搭建

#### 连接网站

librtmp编译集成：https://www.jianshu.com/p/55ffaf8ba0ab

x264 交叉编译：https://www.jianshu.com/p/a99b518f29b9

RTMP视频数据格式：https://www.jianshu.com/p/0c882eca979c

FLV文件格式：https://www.jianshu.com/p/4f6ef65e8b97

#### 学习过程

**添加rtmp**

include <> 系统目录找

include_derectories 相当于把指定目录添加为系统查找目录；

```C++
//C组合字符和数字
char ver[70];
sprintf(ver,"rtmp version: %d",RTMP_LibVersion());
return env->NewStringUTF(ver);
```

```
rtmp.h里定义了NO_CRYPTO，可以避免编译错误openssl
# -L 库查找路径 -D 定义宏
# 目前是纯C环境 用CMAKE_C_FLAGS
在cmake中set(CMAKE_C_FLAGS   "${CMAKE_CXX_FLAGS}   -DNO_CRYPTO")
```

**添加x264库**

在linux下下载编译:`wget https://code.videolan.org/videolan/x264/-/archive/master/x264-master.tar.bz2`
解压:`tar -xvf x264-master.tar.bz2`

```shell
#!/bin/bash

NDK_ROOT=/root/android-ndk-r17c

PREFIX=./android/armeabi-v7a

TOOLCHAIN=$NDK_ROOT/toolchains/arm-linux-androideabi-4.9/prebuilt/linux-x86_64

CFLAGS="-isysroot $NDK_ROOT/sysroot -isystem $NDK_ROOT/sysroot/usr/include/arm-linux-androideabi -D__ANDROID_API__=17 -g -DANDROID -ffunction-sections -funwind-tables -fstack-protector-strong -no-canonical-prefixes -march=armv7-a -mfloat-abi=softfp -mfpu=vfpv3-d16 -mthumb -Wa,--noexecstack -Wformat -Werror=format-security  -O0 -fPIC"

# --disable-cli : 关闭命令行
# 其他和ffmpeg一样
./configure \
--prefix=$PREFIX \
--disable-cli \
--enable-static \
--enable-pic \
--host=arm-linux \
--cross-prefix=$TOOLCHAIN/bin/arm-linux-androideabi- \
--sysroot=$NDK_ROOT/platforms/android-17/arch-arm \
--extra-cflags="$CFLAGS"

make clean
make install

```



**其他**

rtmp.h和x264.h已经自动添加了extern “C”

```
addsubliabry()
```

```
RTMP视频数据格式与FLV格式相似
视频：Camera采集->H264打包->RTMP包->发送
音频：AudioRecord采集->AAC打包->RTMP包->发送

什么是sps参数集序列和pps图像集

NALU网络抽象层，H264是火车NALU是车厢
IDR是关键帧，遇到IDR帧前面的队列立刻被清空
```

```
#java层
CameraHelper
```

​	
